#/bin/bash

echo
echo '================================================================'
echo 'server-docker-ingest-start'
echo '================================================================'
echo

# Starts ingestion server with configurable docker network and mongo URI.
# Parameters:
#   $1 - DOCKER_NETWORK: Docker network name to connect to
#   $2 - MONGO_URI: MongoDB connection string

# The ingestion server can be connected to externally using gRPC endpoint localhost:50051 and internally using
# dp-ingestion-server:50051.

# Some useful commands once the image is running:
# docker ps | grep dp-ingestion-server  # check if image is running
# docker logs dp-ingestion-server       # check logs
# docker stop dp-ingestion-server       # stop the server

if [ $# -ne 2 ]; then
  echo "Usage: $0 <DOCKER_NETWORK> <MONGO_URI>"
  echo "Example: $0 mongo-replica-set-single_default 'mongodb://admin:admin@localhost:27017/?replicaSet=rs0&authSource=admin'"
  exit 1
fi

# Change to the script's directory to ensure relative paths work correctly
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

APP_NAME="mldp-server-ingest:latest"
APP_DOCKERFILE="../docker/applications/JavaApp/Dockerfile"
APP_BUILD_CONTEXT=".."
DOCKER_NETWORK="$1"
MONGO_URI="$2"
CONTAINER_NAME="dp-ingestion-server"
GRPC_PORT="50051"

echo "üîß Building app: $APP_NAME"
docker build -f "$APP_DOCKERFILE" -t "$APP_NAME" "$APP_BUILD_CONTEXT"
if [ $? -ne 0 ]; then
  echo "‚ùå Docker build failed."
  exit 1
fi

echo "üöÄ Starting app: $APP_NAME as container: $CONTAINER_NAME"
echo "   Port: $GRPC_PORT (gRPC)"
echo "   Network: $DOCKER_NETWORK"

# Stop existing container if running
docker stop "$CONTAINER_NAME" 2>/dev/null || true
docker rm "$CONTAINER_NAME" 2>/dev/null || true

docker run -d \
  --name "$CONTAINER_NAME" \
  --network "$DOCKER_NETWORK" \
  -p "$GRPC_PORT:50051" \
  "$APP_NAME" \
  -Ddp.MongoClient.uri="$MONGO_URI" \
  -cp /app/dp-service.jar \
  com.ospreydcs.dp.service.ingest.server.IngestionGrpcServer

if [ $? -eq 0 ]; then
  echo "‚úÖ Container '$CONTAINER_NAME' started successfully"
  echo "   External gRPC access: localhost:$GRPC_PORT"
  echo "   Internal network access: $CONTAINER_NAME:50051"
  echo ""
  echo "Check logs: docker logs $CONTAINER_NAME"
  echo "Stop server: docker stop $CONTAINER_NAME"
else
  echo "‚ùå Docker run failed."
  exit 1
fi
