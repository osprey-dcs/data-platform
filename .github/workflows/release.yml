name: Release Data Platform Tarball

on:
  push:
    tags:
      - 'rel-*'

env:
  DP_SERVICE_REPO: osprey-dcs/dp-service
  DP_DESKTOP_APP_REPO: osprey-dcs/dp-desktop-app
  DP_GRPC_REPO: osprey-dcs/dp-grpc

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:

      # Checkout data-platform repo
      - name: Checkout
        uses: actions/checkout@v3

      # Extract version from tag
      - name: Set VERSION env
        run: |
          echo "VERSION=${GITHUB_REF_NAME#rel-}" >> $GITHUB_ENV

      # Create directory structure
      - name: Create installer directories
        run: |
          mkdir -p data-platform/config
          mkdir -p data-platform/bin
          mkdir -p data-platform/docker
          mkdir -p data-platform/kubernetes
          mkdir -p data-platform/lib
          mkdir -p data-platform/templates
          mkdir -p data-platform/proto
          mkdir -p data-platform/var/lock
          mkdir -p data-platform/var/log

      # Copy static config and templates from repo
      - name: Copy config and templates
        run: |
          cp config/* data-platform/config/ || true
          cp templates/* data-platform/templates/ || true
          test -e README.env && cp README.env data-platform/ || true

      # Copy support scripts (optional, if hosted in repo)
      - name: Copy support scripts
        run: |
          test -d bin && cp -r bin/* data-platform/bin/ || true

      - name: Copy docker and kubernetes assets
        run: |
          test -d docker && cp -r docker data-platform/ || true
          test -d kubernetes && cp -r kubernetes data-platform/ || true

      - name: Download dp-grpc release JAR
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_GRPC_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-grpc-${{ env.VERSION }}.jar
          out-file-path: data-platform/lib
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize dp-grpc JAR name
        run: |
          mv data-platform/lib/dp-grpc-${VERSION}.jar \
             data-platform/lib/dp-grpc.jar

      - name: Download dp-service release JAR
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_SERVICE_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-service-${{ env.VERSION }}.jar
          out-file-path: data-platform/lib
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Normalize dp-service JAR name
        run: |
          mv data-platform/lib/dp-service-${VERSION}.jar \
             data-platform/lib/dp-service.jar

      - name: Download dp-desktop-app release JAR
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_DESKTOP_APP_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-desktop-app-${{ env.VERSION }}.jar
          out-file-path: data-platform/lib
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Normalize dp-desktop-app JAR name
        run: |
          mv data-platform/lib/dp-desktop-app-${VERSION}.jar \
             data-platform/lib/dp-desktop-app.jar

      - name: Verify lib contents
        run: |
          ls -lh data-platform/lib

      - name: Ensure all jars present
        run: |
          test -f data-platform/lib/dp-grpc.jar
          test -f data-platform/lib/dp-service.jar
          test -f data-platform/lib/dp-desktop-app.jar

      # Create tarball
      - name: Create tarball
        run: |
          TAR_FILE=data-platform-${{ env.VERSION }}.tar.gz
          tar czf $TAR_FILE -C data-platform .
          echo "Created tarball: $TAR_FILE"

      - name: Generate checksum
        run: |
          sha256sum data-platform-${{ env.VERSION }}.tar.gz \
            > data-platform-${{ env.VERSION }}.tar.gz.sha256

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            data-platform-${{ env.VERSION }}.tar.gz
            data-platform-${{ env.VERSION }}.tar.gz.sha256
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


