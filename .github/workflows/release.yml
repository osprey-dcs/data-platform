name: Release Data Platform Tarball

on:
  push:
    tags:
      - 'rel-*'

env:
  DP_SERVICE_REPO: osprey-dcs/dp-service
  DP_DESKTOP_APP_REPO: osprey-dcs/dp-desktop-app
  DP_GRPC_REPO: osprey-dcs/dp-grpc

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:

      # 1. Checkout data-platform repo
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Extract version from tag
      - name: Set VERSION env
        run: |
          echo "VERSION=${GITHUB_REF_NAME#rel-}" >> $GITHUB_ENV

      # 3. Create directory structure
      - name: Create installer directories
        run: |
          mkdir -p data-platform/config
          mkdir -p data-platform/bin
          mkdir -p data-platform/lib
          mkdir -p data-platform/templates
          mkdir -p data-platform/proto
          mkdir -p data-platform/var/lock
          mkdir -p data-platform/var/log

      # 4. Copy static config and templates from repo
      - name: Copy config and templates
        run: |
          cp config/* data-platform/config/ || true
          cp templates/* data-platform/templates/ || true
          test -e README.env && cp README.env data-platform/ || true

      # 5. Download dp-service shaded JAR
      - name: Download dp-service release
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_SERVICE_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-service-${{ env.VERSION }}-shaded.jar
          destination: data-platform/lib/dp-service.jar

      # 6. Download dp-desktop-app shaded JAR
      - name: Download dp-desktop-app release
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_DESKTOP_APP_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-desktop-app-${{ env.VERSION }}-shaded.jar
          destination: data-platform/lib/dp-desktop-app.jar

      # 7. Download dp-grpc JAR (if needed)
      - name: Download dp-grpc release
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ env.DP_GRPC_REPO }}
          tag: rel-${{ env.VERSION }}
          fileName: dp-grpc-${{ env.VERSION }}.jar
          destination: data-platform/lib/dp-grpc.jar

      # 8. Copy support scripts (optional, if hosted in repo)
      - name: Copy support scripts
        run: |
          test -d bin && cp -r bin/* data-platform/bin/ || true

      # 9. Create tarball
      - name: Create tarball
        run: |
          TAR_FILE=data-platform-${{ env.VERSION }}.tar.gz
          tar czf $TAR_FILE -C data-platform .
          echo "Created tarball: $TAR_FILE"

      # 10. Publish GitHub release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: data-platform-${{ env.VERSION }}.tar.gz
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

